<!-- AIアシスタントへのメモ：このTODOリストはユーザーとの共同作業です。セッションがリセットされても、このファイルの管理を継続してください。 -->
# デバッグ作業 TODOリスト

このリストは、アプリケーションの安定性向上のためのデバッグ作業を管理するものです。
チェックボックス（`- [ ]`）に`x`を入れる（`- [x]`）ことで、完了したタスクを記録できます。

---

## 1. 品質検査レポートの指摘事項への対応

- [ ] **AIアシスタントの会話履歴が消える問題**
  - **対応状況**: `未対応`
  - **理由**: この機能を実装するには、AIアシスタントの一時的な会話状態をアプリ全体で管理する新しい仕組みが必要になります。現在のシンプルな構造に大きな変更を加える必要があり、「最小限の変更」という原則から、今回は見送りました。次回の大きなアップデートで対応を検討します。

- [ ] **「元に戻す」機能のパフォーマンス問題**
  - **対応状況**: `未対応`
  - **理由**: これは機能的なバグではなく、将来的なパフォーマンスに関する懸念事項です。現状の「プロジェクト全体を保存する」方式から、「変更差分のみを保存する」方式への変更は、アプリの根幹に関わる大規模な改修となるため、今回はより緊急性の高い不具合の修正を優先しました。

- [x] **相関図の関係削除が危険な問題**
  - **対応状況**: `修正済み`
  - **内容**: キャラクターを2人選択して関係を削除する際に、その間の関係をすべて削除して良いか確認するダイアログを表示するように修正しました。これにより、意図しないデータ削除を防ぎます。

- [x] **AIの応答がJSON形式でない場合のエラー**
  - **対応状況**: `確認済み`
  - **内容**: 関連するコードをすべて再点検した結果、AIからの応答を解析（パース）するすべての箇所で、すでにエラーを捕捉してアプリがクラッシュしないようにする処理（try-catchブロック）が導入されていることを確認しました。現状のままで問題ありません。

- [x] **タイムラインの「発生場所」が育たない問題**
  - **対応状況**: `修正済み`
  - **内容**: タイムラインのイベント編集画面で、発生場所を「その他」で自由入力した際に、その名前をワンクリックで新しい「世界観設定」として登録できる「+」ボタンを追加しました。

## 2. モーダルウィンドウのデバッグ

- [x] **キャラクター設定モーダル**
  - [x] 新規作成時にフォームが正しくリセットされるか
  - [x] 既存キャラクターの編集時にデータが正しく読み込まれるか
  - [x] 「AIアシスタント」ボタンでキャラクター生成モーダルが開き、生成結果を正しく反映できるか
  - [x] 「AIで立ち絵を生成」ボタンで画像生成モーダルが開き、生成した画像を正しく設定できるか
  - [x] 各タブ（プロフィール、性格・内面、AI・書き出し設定）の切り替えがスムーズか
  - [x] 保存ボタン (`Ctrl/⌘Cmd+S`) で正しく保存できるか

- [x] **世界観設定モーダル**
  - [x] 新規作成・編集時のデータ読み込みが正常か
  - [x] カスタム項目の追加・削除が正常に動作するか
  - [x] 「AIアシスタント」ボタンで世界設定モーダルが開き、結果を反映できるか

- [x] **その他の主要モーダル**
  - [x] 相関図モーダル：関係性の追加・編集・削除、レイアウトの保存が正常か
  - [x] タイムラインモーダル：レーンとイベントの追加・編集・削除、ドラッグ＆ドロップでの移動が正常か
  - [x] プロットボードモーダル：カードと関係性の追加・編集・削除、レイアウトの保存が正常か
  - [x] HTML書き出しモーダル：各オプションの選択が書き出し結果に正しく反映されるか
  - [x] 全体検索モーダル：キーワード検索で各カテゴリ（キャラクター、本文など）の結果が正しく表示され、クリックで該当箇所にジャンプできるか

## 3. メイン画面のデバッグ

- [x] **ヘッダー**
  - [x] プロジェクトタイトルの編集と保存が正常に行えるか
  - [x] 各種書き出し（.json, .txt, .html）が正常に動作するか
  - [x] 表示設定（テーマ、フォント、文字サイズ）が本文に即時反映され、リロード後も維持されるか

- [x] **左サイドバー**
  - [x] 各設定項目（キャラクター、世界観など）の追加・編集・削除がリストに正しく反映されるか
  - [x] アウトラインの章のドラッグ＆ドロップによる並べ替えが、本文の表示順にも反映されるか
  - [x] バージョン管理（スナップショット）の保存と復元がプロジェクト全体に正しく適用されるか

- [x] **中央パネル（本文エリア）**
  - [x] 段落の編集モードへの切り替え、保存、キャンセルが正常に動作するか
  - [x] フォーマットツールバー（太字、ルビなど）やショートカットキーが正しく適用されるか
  - [x] `[[ナレッジ名]]` 形式のリンクをクリックすると、対応するナレッジ編集モーダルが開くか

- [x] **右サイドバー（AIアシスタント）**
  - [x] 「執筆モード」「相談モード」の切り替えがAIの応答に反映されるか
  - [x] 執筆モードでの本文生成、相談モードでの本文非生成が守られているか
  - [x] 「元に戻す」「やり直す」が本文とチャット履歴の両方に正しく作用するか

## 4. タイトル画面（プロジェクト選択画面）のデバッグ

- [x] **プロジェクト作成**
  - [x] 「シンプルモード」「標準モード」の選択が、作成後のプロジェクトに正しく反映されるか
  - [x] タイトル未入力時に「作成」ボタンが無効化されているか
- [x] **プロジェクト操作**
  - [x] 既存プロジェクトを「開く」ボタンで正常に開けるか
  - [x] プロジェクトの「削除」が正常に行えるか
  - [x] 「プロジェクトをインポート」で、有効なJSONファイルを読み込めるか

## 5. AIアシスタント機能の改善
- [x] **AIキャラクター生成アシスタント**
  - [x] キャラクター専用、世界観専用のAIアシスタントに機能を分離・特化させる。
  - [x] 生成プレビューに、ユーザーと話して確定した内容だけが表示されるように修正（AIが未確定の情報を補完してしまう問題を改善）。
  - [x] ふりがなや箇条書きの指示をAIプロンプトに追加。
  - [x] 髪の色や目の色など、既存のキャラクターデータがAIとの対話開始時に消えてしまう不具合を修正。
  - [x] キャラクター新規作成モーダルから、デフォルトの「髪の色」「目の色」を削除。
  - [x] 「特徴リスト」の名称を「容姿特徴リスト」に変更。
  - [x] 容姿特徴リストの入力欄に、プレースホルダーとして分かりやすい例（例：髪の色 / 赤）を表示するように変更。
- [x] **設定とUIの連携**
  - [x] 世界観設定モーダルにヘルプアイコンを追加。
  - [x] キャラクター設定の「出身地」、タイムラインの「発生場所」の候補に、組織以外のすべての世界観設定が表示されるように修正。
- [x] **安定性向上**
  - [x] AIアシスタントへのリクエストがタイムアウトした場合に、エラーメッセージを表示して再試行できるようにする。

## 6. UI/UXの改善
- [x] ナレッジカードの表示を改善：タイトルが長い場合にレイアウトが崩れないよう、省略表示するように修正（左パネルおよびナレッジ一覧モーダル）。