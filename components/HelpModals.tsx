
import React, { useMemo, useState, useEffect, useRef } from 'react';
import * as Icons from '../icons';
import { helpContent } from '../constants';
import { parseMarkdown } from '../utils';
import { useStore } from '../store/index';

const siteMapContent = `【プロジェクト選択画面】
      │
      ├─ 新規プロジェクト作成
      │     ├─ シンプルモード or 標準モード選択
      │     ├─ タイトル入力
      │     └─ 「作成」ボタン
      │           ▼
      │         【メイン画面】
      │
      ├─ プロジェクトをインポート
      │     ├─ ファイル選択
      │     └─ ▼【メイン画面】
      │
      └─ 既存プロジェクト一覧
            ├─ 「開く」ボタン
            └─ ▼【メイン画面】
                  │
                  ▼

【メイン画面】
      │
      ├─ ヘッダー
      │     ├─ 「プロジェクト一覧へ」ボタン → ▼【プロジェクト選択画面】
      │     ├─ 「エクスポート」ボタン (プロジェクト.json)
      │     ├─ タイトル部分クリック (タイトル編集)
      │     ├─ 「検索」ボタン (Ctrl+F) → ▼【全体検索モーダル】
      │     ├─ 「表示設定」ボタン → ▼【表示設定ポップオーバー】
      │     ├─ モード切替ボタン (標準/シンプル)
      │     ├─ 「プレビュー」ボタン → ▼【プレビューモーダル】
      │     ├─ 「.txtで出力」ボタン
      │     ├─ 「.htmlで出力」ボタン → ▼【HTML書き出しモーダル】
      │     └─ サイドバー開閉ボタン
      │
      ├─ 左サイドバー (標準モードのみ)
      │     └─ タブ切替ドロップダウン
      │           ├─ 設定ライブラリ
      │           │    ├─ 「設定」ボタン → ▼【設定モーダル】
      │           │    ├─ キャラクター追加 → ▼【キャラクター設定モーダル】
      │           │    ├─ 世界観追加 → ▼【世界観設定モーダル】
      │           │    ├─ 「相関図を表示」 → ▼【相関図モーダル】
      │           │    ├─ 「タイムライン」 → ▼【タイムラインモーダル】
      │           │    ├─ 「ジェネレーター」 → ▼【固有名詞生成モーダル】
      │           │    ├─ ナレッジ追加 → ▼【ナレッジ設定モーダル】
      │           │    └─ プロット追加 → ▼【プロットボードモーダル】
      │           │
      │           └─ アウトライン
      │                ├─ 章タイトルクリック (本文へスクロール)
      │                ├─ 「設定」ボタン → ▼【章設定モーダル】
      │                └─ 「新しい章を追加」
      │
      ├─ 中央パネル (本文)
      │     ├─ 段落の編集・ピン留め
      │     └─ 本文の直接入力エリア
      │
      └─ 右サイドバー (AIアシスタント)
            ├─ 「ヘルプ」ボタン → ▼【一般ヘルプモーダル】
            ├─ 元に戻す / やり直す
            ├─ 相談/執筆モード切替
            └─ 指示入力・送信
`;

const manualContent = {
    'index.md': `# 小説らいたー 取扱説明書

「小説らいたー」へようこそ！
このアプリは、**「あなた専属のAIアシスタント」と一緒に、物語を作るための執筆ツール**です。

小説を書くのは、とても楽しいけれど、孤独で大変な作業でもありますよね。
アイデアが出なくて悩んだり、文章がうまく繋がらなくて止まってしまったり……。

そんなとき、このアプリのAIアシスタントがあなたの隣でサポートします。
相談相手になったり、続きの文章を提案したり、設定を一緒に考えたり。
あくまで**「主役はあなた」**。AIはあなたの創作をお手伝いする「後輩」や「パートナー」のような存在です。

このマニュアルでは、難しい言葉を使わずに、アプリの使い方をわかりやすく説明します。
まずは気になるところから読んでみてくださいね。

---

## 📚 目次

1.  **[物語の始め方と保存（プロジェクト管理）](./01-project-management.md)**
    *   まずは新しいノートを開くように、物語の箱（プロジェクト）を作りましょう。
    *   大切なデータを守るための「保存」についても説明します。

2.  **[画面の見方（作業机の配置）](./02-screen-layout.md)**
    *   画面は「資料」「原稿」「アシスタント」の3つに分かれています。
    *   それぞれの役割をサッと確認しましょう。

3.  **[設定・資料の管理（左パネル）](./03-library-panel.md)**
    *   キャラクターや世界観、年表などをまとめる「ネタ帳」の使い方です。
    *   ここを充実させると、AIがあなたの作品を深く理解してくれます。

4.  **[AIと一緒に書く・相談する（右パネル）](./04-assistant-panel.md)**
    *   このアプリの目玉機能！
    *   「続きを書いてもらう」だけでなく、「アイデア出し」や「壁打ち」の方法も紹介します。

5.  **[本文を書く・整える（中央パネル）](./05-main-panel.md)**
    *   実際に文章を書く場所です。
    *   ルビを振ったり、AIに誤字脱字をチェックしてもらったりする方法もこちら。

6.  **[AIの性格を変える（設定）](./06-ai-settings.md)**
    *   アシスタントの「口調」や「提案の傾向」を、あなた好みにカスタマイズしましょう。

7.  **[UIリファレンスとサイトマップ](./07-ui-reference.md)**
    *   「このボタンなんだっけ？」と思ったらこちら。全機能を網羅しています。

---

困ったときは、いつでもこのマニュアルに戻ってきてください。
さあ、あなただけの物語を紡ぎ始めましょう！`,
    '01-project-management.md': `# 1. 物語の始め方と保存（プロジェクト管理）

ここでは、新しい物語を書き始める手順と、書いたものを保存・管理する方法を説明します。

---

## 新しい物語を始める（プロジェクト作成）

まずは、新しいノートを一冊用意するような気持ちで、「プロジェクト」を作成しましょう。

### ① この機能でできること
*   新しい小説のための「専用の執筆スペース」を作ります。
*   初心者向けのシンプルな画面か、多機能な画面かを選べます。

### ② こんな人・こんな場面におすすめ
*   「よし、新しい小説を書くぞ！」と思い立ったとき。
*   別の作品を書き始めたくなったとき。

### ③ 基本的な使い方
1.  アプリを開いた最初の画面（または左上の「←」ボタンで戻った画面）を見ます。
2.  **「モード」**を選びます。
    *   **シンプルモード**: 必要な機能だけを表示します。「まずは書くことに集中したい！」という方におすすめ。
    *   **標準モード**: 全ての機能が使えます。「設定もAIもしっかり使いこなしたい！」という方におすすめ。
3.  **「物語のタイトル」**を入力します。（後でいつでも変えられるので、仮のタイトルで大丈夫！）
4.  **「作成」ボタン**を押すと、執筆画面が開きます。

---

## 続きから書く・作品を消す

### 既存の物語リスト
画面の下の方に、これまで作った作品がリストで並んでいます。
*   **開く**: 続きを書きたいときは、このボタンを押します。
*   **ゴミ箱アイコン**: 作りかけの作品を完全に削除します。**一度消すと元に戻せない**ので注意してくださいね。

---

## 【重要】データの保存と読み込み（インポート・エクスポート）

このアプリの大切な特徴として、**「データはあなたのブラウザ（今使っているアプリ）の中に保存されている」**という点があります。
インターネット上のサーバーには保存していません。

### ⚠️ 気をつけてほしいこと
ブラウザの履歴を消したり、パソコンを買い替えたりすると、**物語が消えてしまう可能性**があります。
大切な作品を守るために、定期的に「ファイルの書き出し（バックアップ）」を行いましょう。

### ファイルの書き出し（エクスポート）
あなたの作品を、一つのファイル（\` .json \` という形式）にして、パソコンやスマホの中に保存します。

1.  執筆画面の左上にあるメニュー（またはヘッダー）から**「エクスポート」**を選びます。
2.  「プロジェクト(.json)」を選ぶと、ファイルがダウンロードされます。
3.  このファイルを大切に保管しておけば、データが消えても安心です。

### ファイルの読み込み（インポート）
保存しておいたファイルから、物語を復元します。

1.  最初の画面で**「プロジェクトをインポート」**ボタンを押します。
2.  以前に保存した \` .json \` ファイルを選びます。
3.  物語が元通りに読み込まれ、続きから執筆できます。

### ④ 使うとどんなメリットがあるか
*   こまめにエクスポートしておけば、万が一のときも安心です。
*   別のパソコンやスマホにファイルを送れば、環境を変えて執筆の続きができます。

### ⑤ うまく使うコツ
*   「第一章が終わった」「設定が固まった」など、区切りのいいタイミングでエクスポートする癖をつけると良いでしょう。
*   ファイル名に日付を入れておくと（例：\`冒険の書_20240501.json\`）、いつの状態かわかりやすくなります。

[目次に戻る](./index.md)`,
    '02-screen-layout.md': `# 2. 画面の見方（作業机の配置）

執筆画面（メイン画面）は、大きく3つのエリアに分かれています。
作家さんの「作業机」をイメージするとわかりやすいですよ！

---

## ① 左パネル：資料と設定の棚（設定ライブラリ）

机の左側にある本棚のようなスペースです。
ここには、物語を作るための「材料」を置いておきます。

*   **何がある？**:
    *   **設定**: キャラクターのプロフィールや、世界観のメモ。
    *   **ナレッジ**: 魔法のルールや、国の歴史などの事典。
    *   **プロット**: 物語の構成やあらすじメモ。
*   **役割**:
    *   あなたがいつでも見返せるだけでなく、**AIもここを読んで物語を理解します。**
    *   ここに詳しく書けば書くほど、AIはあなたの作品に詳しくなります。

---

## ② 中央パネル：原稿用紙（本文エディタ）

机の真ん中にある、一番大切なスペースです。
ここで物語がつむがれていきます。

*   **何がある？**:
    *   あなたが書いた文章。
    *   AIが書いてくれた文章。
*   **役割**:
    *   文章を書いたり、直したり、読み返したりする場所です。
    *   書いた文章は、段落ごとに分かれて保存されていきます。

---

## ③ 右パネル：頼れる相棒（AIアシスタント）

机の右隣に座っている、優秀なアシスタントさんです。
困ったときはいつでも話しかけてください。

*   **何がある？**:
    *   AIとのチャット画面（相談や指示）。
    *   AIからの提案リスト。
*   **役割**:
    *   「次の展開どうしよう？」と相談に乗ってくれます（相談モード）。
    *   「続きを書いて！」と頼むと、代わりに書いてくれます（執筆モード）。

---

### モードによる見た目の違い

*   **標準モード**: 上記の3つのパネルがすべて表示されます。じっくり腰を据えて書きたいときに。
*   **シンプルモード**: 左右のパネルを閉じて、中央の「原稿用紙」だけに集中できます。スマホで書くときや、とにかく筆を進めたいときに便利です。

[目次に戻る](./index.md)`,
    '03-library-panel.md': `# 3. 設定・資料の管理（左パネル）

左パネルは、あなたの物語の「設定資料集」を作る場所です。
ここで作った設定は、AIが物語を書くときに**「教科書」として参照**します。
つまり、ここを充実させると、AIが「キャラクターらしいセリフ」や「矛盾のない展開」を書けるようになるんです！

---

## キャラクター設定

登場人物のプロフィールを作る機能です。

### ① この機能でできること
名前、年齢、性格、外見、話し方などを詳しく登録できます。
AIと対話しながら作ることもできます。

### ② こんな人・こんな場面におすすめ
*   新キャラを登場させたいとき。
*   「このキャラ、どんな性格だっけ？」とAIに勘違いされたくないとき。

### ③ 基本的な使い方
1.  「キャラクター」の横の **「＋」ボタン** を押します。
2.  名前や性格を入力します。
3.  **「AIアシスタント」ボタン** を押すと、「明るい少女」などのイメージを伝えるだけで、AIが詳細なプロフィールを提案してくれます！便利ですよ。
4.  **「保存」** を押します。

### ④ 使うとどんなメリットがあるか
*   AIが執筆するとき、そのキャラの性格や口調を真似してくれるようになります。
*   「AI立ち絵生成」機能を使って、キャラのイメージ画像を作ることもできます。

---

## 世界観設定

物語の舞台となる場所や、組織などを登録する機能です。

### ① この機能でできること
「〇〇王国」「冒険者ギルド」「魔法の仕組み」などの設定を保存できます。

### ⑤ うまく使うコツ
*   テンプレート機能があるので、「場所」や「組織」などを選ぶだけで、必要な項目（リーダー、場所、目的など）が自動でセットされます。

---

## ナレッジベース (Wiki機能)

物語の中の「ルール」や「専門用語」をまとめる事典です。

### ① この機能でできること
AIに「これだけは守って！」というルールを教えることができます。
例えば「魔法を使うには杖が必要」「この国には王様がいない」など。

### ② こんな人・こんな場面におすすめ
*   ファンタジーやSFなど、独自の設定が多い物語を書くとき。
*   AIが勝手に設定を捏造するのを防ぎたいとき。

### ③ 基本的な使い方
1.  「ナレッジベース」の **「＋」ボタン** を押します。
2.  項目名（例：エクスカリバー）と、内容（例：選ばれた勇者しか抜けない剣）を書きます。
3.  **ピン留めアイコン** を押すと、その設定をAIが「常に強く意識」するようになります。特に重要なルールにおすすめです。

---

## 相関図（キャラクター関係図）

誰と誰が仲良しか、敵対しているかを図で整理できます。

### ① この機能でできること
キャラクター同士を線で結んで、「ライバル」「親子」「片思い」などの関係性を可視化できます。

### ④ 使うとどんなメリットがあるか
*   人間関係が複雑になっても、パッと見て状況を把握できます。
*   AIもこの関係性を理解して、キャラ同士の会話を生成します。

---

## タイムライン（年表）

物語の出来事を時系列で並べる機能です。

### ① この機能でできること
「いつ」「どこで」「誰が」「何をしたか」をカードにして並べられます。
「主人公の動き」と「敵の動き」を別の列（レーン）で管理することもできます。

### ④ 使うとどんなメリットがあるか
*   「あれ？この時この人はまだ生まれてないはずじゃ…」といった矛盾を防げます。
*   伏線のタイミングを調整するのに便利です。

---

## プロットボード

物語の構成（あらすじ）を練るためのボードです。

### ① この機能でできること
「第一章のあらすじ」「クライマックスの展開」などをカードにして、並べ替えたりつなげたりできます。

### ⑤ うまく使うコツ
*   AIに「ここまでの話をまとめて」とお願いすると、自動でこのボードにあらすじカードを作ってくれることがあります。長編を書くときに重宝しますよ！

[目次に戻る](./index.md)`,
    '04-assistant-panel.md': `# 4. AIと一緒に書く・相談する（右パネル）

右パネルは、AIアシスタントとの対話スペースです。
ここでは、AIの**2つのモード**を使い分けることがとても大切です。

---

## モードの切り替え

パネルの上の方にあるボタンで、AIの役割を切り替えられます。

### 🟢 相談モード（緑色）
**「物語については書かない。アイデア出しや相談だけをする」**モードです。
*   **役割**: 編集者、友人、壁打ち相手
*   **できること**:
    *   「次の展開のアイデアを3つ出して」
    *   「このキャラの名前を考えて」
    *   「ここまでの設定で矛盾してるところある？」
    *   「やる気が出るように褒めて！」
*   **特徴**: おしゃべりをするだけなので、**本文（原稿）は増えません。**安心して相談できます。

### 🔵 執筆モード（青色）
**「あなたの指示に従って、物語の続きを書く」**モードです。
*   **役割**: ゴーストライター、共同執筆者
*   **できること**:
    *   「主人公が洞窟に入るシーンを描写して」
    *   「二人が喧嘩別れする会話を書いて」
    *   「（何も書かずに送信して）続きをおまかせ！」
*   **特徴**: AIが考えた文章が、**中央パネルの本文に直接追加されます。**

---

## 具体的な活用例

### ケース1：アイデアが浮かばないとき
1.  **「相談モード」**にします。
2.  「主人公がピンチになる場面なんだけど、何か面白い切り抜け方ない？」と聞きます。
3.  AIがいくつかアイデアを出してくれるので、気に入ったものを採用したり、それをヒントに自分で考えたりします。

### ケース2：書きたいシーンはあるけど、文章にするのが面倒なとき
1.  **「執筆モード」**にします。
2.  「主人公はカフェに入って、コーヒーを注文する。窓の外は雨が降っている。物憂げな雰囲気で書いて」と指示します。
3.  AIがその通りの文章を書いてくれます。
4.  気に入らない部分があれば、自分で直したり、書き直しを指示したりします。

### ケース3：AIに複数のパターンを出してほしいとき
1.  **「執筆モード」**にします。
2.  パネルにある **「複数提案」スイッチ** をONにします。
3.  指示を出すと、AIが**3パターンの異なる展開**を書いてくれます。
4.  「この展開を採用」ボタンを押すと、選んだものが本文に追加されます。

---

## AIからの提案機能

会話していると、AIが気を利かせて提案をしてくることがあります。

*   **ナレッジ提案**: 「今の話に出てきた『炎の剣』を、設定資料（ナレッジ）に追加しておきませんか？」
*   **プロット提案**: 「ここまでの話をあらすじとしてまとめておきますか？」

**「承認」**ボタンを押すと、自動で左パネルの資料に追加してくれます。
面倒な整理整頓をAIがやってくれる、とても便利な機能です！

---

## うまく使うコツ

*   **AIは「直前の文章」と「左パネルの設定」を見ています。**
    *   意図と違う文章が出てきたら、左パネルの設定が足りていないか、直前の文章が説明不足かもしれません。
*   **「やり直し」は何度でもOK！**
    *   AIの書いた文章が気に入らなければ、右上の「元に戻す（矢印アイコン）」を押せば無かったことにできます。
    *   「もっとシリアスに書き直して」「セリフ多めで」など、注文をつけて書き直させましょう。

[目次に戻る](./index.md)`,
    '05-main-panel.md': `# 5. 本文を書く・整える（中央パネル）

中央パネルは、小説の本文が表示される場所です。
AIが書いた文章もここに溜まっていきますが、もちろんあなた自身の手で自由に編集できます。

---

## 文章の編集方法

### 編集モードにする
文章の段落（かたまり）の上にマウスを乗せると、右側にペンのマーク（編集ボタン）が出ます。
これをクリックすると、その段落を書き直すことができます。

### 編集を保存する
書き終わったら、枠の外をクリックするか、\`Ctrl\` キーを押しながら \`Enter\` キーを押すと保存されます。

### 新しい文章を書く
一番下に「本文を直接入力」というエリアがあります。
ここをクリックして文章を書き、「本文に追加」ボタンを押すと、物語の続きとして追加されます。

---

## 文章を整える（装飾・ルビ）

編集モードの間、画面の上に**ツールバー**が表示されます。これを使うと、文章を見やすく飾ることができます。

### ① この機能でできること
*   **B (太字)**: 文字を太く強調します。
*   **U (下線)**: 文字に線を引きます。
*   **H (見出し)**: 章のタイトルなどに使います。文字が大きくなります。
*   **ルビ**: 漢字にふりがなを振れます。
    *   使い方：漢字を選択して「ルビ」ボタンを押し、\`|\` の後ろに読み仮名を書きます。
    *   例：\`{強敵|とも}\` → 「強敵」と書いて「とも」と読ませる表示になります。
*   **色**: 文字に色をつけます。

---

## 便利機能：テキスト選択ツールバー

これがこのアプリの隠れた便利機能です！
本文中のテキストをマウスで選択（反転）すると、小さなメニューがポップアップします。

### ① 校正して
選択した文章の誤字脱字や、不自然な日本語をAIがチェックして直してくれます。

### ② 要約して
長すぎる文章を、AIがギュッと短くまとめてくれます。

### ③ より詩的に / 会話文に
*   **詩的に**: 文章をエモーショナルで美しい表現に書き換えてくれます。
*   **会話文に**: 地の文（説明文）を、キャラクターのセリフに変換してくれます。

---

## ピン留め機能

段落の右上に表示される「画鋲（ピン）マーク」を押すと、その段落が黄色く光ります。

### ④ 使うとどんなメリットがあるか
ピン留めされた文章は、**AIが「絶対に忘れてはいけない重要なシーン」として記憶します。**
物語が長くなっても、AIに覚えていてほしい重要な伏線や約束のシーンなどは、ピン留めしておくと良いでしょう。

---

## 話者カラー機能（上級者向け）

設定でONにすると、キャラクターごとにセリフの色を変えることができます。
「誰が喋っているか」が一目でわかるので、会話劇を書くときに便利です。
（詳しくは「設定」のマニュアルをご覧ください）

[目次に戻る](./index.md)`,
    '06-ai-settings.md': `# 6. AIの性格を変える（設定）

左パネルの一番上にある「設定」ボタン（歯車マーク）から、AIアシスタントの振る舞いをあなた好みにカスタマイズできます。
「どんな後輩に手伝ってほしいか」を調整するイメージです。

---

## あなたのプロフィール設定

*   **ユーザーアイコン**: AIとのチャット画面で表示されるあなたの顔です。好きな画像をアップロードできます。
*   **ユーザーネーム**: AIがあなたを呼ぶ時の名前です。「先生」「師匠」「〇〇さん」など、呼ばれたい名前を入れておくと、AIとの会話が少し楽しくなりますよ。

---

## AIアシスタントの調整

AIの「仕事ぶり」を細かく指示できます。

### ① AIアシスタントの口調（ペルソナ）
相談モードの時の、AIの性格を選べます。
*   **丁寧な編集者**: 「〜ですね」「素晴らしいです」と優しく敬語でサポートしてくれます。
*   **親しい友人**: 「〜だね！」「めっちゃいいじゃん！」とタメ口で明るく励ましてくれます。
*   **分析的な批評家**: 「論理的に矛盾があります」と厳しく冷静にツッコミを入れてくれます。推敲のときに便利！
*   **熱狂的なファン**: とにかくあなたの作品を褒めちぎってくれます。モチベーションを上げたいときに。

### ② 文体・視点
執筆モードでAIが書く文章のスタイルです。
*   **一人称**: 「私は〜」「僕は〜」という視点で書きます。
*   **三人称**: 「彼は〜」「彼女は〜」という神の視点で書きます。

### ③ 生成する文章量
AIに一度に書いてもらう長さです。
「短め」にすると会話のテンポが良くなり、「長め」にすると情景描写が細かくなります。

### ④ 創造性のレベル
*   **控えめ**: あなたの指示や設定を忠実に守ります。手堅い展開になります。
*   **大胆**: AIが自由に発想を広げます。予想外の展開や、突飛なアイデアが欲しいときに。

### ⑤ ユーザーの文体の模倣
これをONにすると、AIがあなたの過去の文章を読んで、**「あなたの書き癖」を真似してくれます。**
「AIが書いた部分だけ浮いてしまう」ということを防げる、すごい機能です！

---

## その他の設定

*   **セリフの話者名表示**: 脚本のように \`太郎「こんにちは」\` と書くか、小説のように \`「こんにちは」\` と書くかを選べます。
*   **ナレッジの参照強度**: 設定資料をどれくらい厳密に守るか決められます。「厳格」にすると、設定に反する展開を書かなくなります。

---

### ⑤ うまく使うコツ
最初から完璧に設定する必要はありません。
「なんかAIのテンションが合わないな？」「もっと自由に書いてほしいな」と思ったときに、ここを開いて少し調整してみるのがおすすめです。
いろいろ試して、あなたにとって最高のパートナーに育ててあげてくださいね！

[目次に戻る](./index.md)`,
    '07-ui-reference.md': siteMapContent,
    '08-test-cases.md': `# 8. 動作確認項目（チェックリスト）\n\nこのドキュメントは、「小説らいたー」の各機能が意図通りに正しく動作することを確認するための、詳細なテスト項目をまとめたものです。\n\n---\n\n## 0. テストの準備：まっさらな状態から始める\n\n| テスト項目 | 操作手順 | 期待される結果 |\n| :--- | :--- | :--- |\n| **データのリセット** | 1. \`F12\`キーで開発者ツールを開く<br>2. 「アプリケーション」タブで「ローカルストレージ」を選択<br>3. 表示されたドメインを右クリックし、「クリア」を選択<br>4. ページをリロードする | 1. プロジェクト選択画面が表示され、既存のプロジェクトが一つも表示されていない状態になる |\n\n（以降、省略）`,
    '09-user-acceptance-test.md': `# 9. ユーザー総合テストシナリオ\n\n## はじめに：君は今日から新人作家！\n\nこのテストは、あなたが「一人の作家」として、この「小説らいたー」アプリを使って**短編小説を一本書き上げる**までをシミュレートするものです。\n\n---\n\n### Step 0: テストの準備\n\n| 操作手順 | 期待される結果 |\n| :--- | :--- |\n| 1. 開発者ツールでローカルストレージをクリア<br>2. ページをリロードする | 最初の画面が表示される |\n\n（以降、省略）`,
};


export const HelpModal = ({ isOpen, onClose, topic }) => {
    if (!isOpen || !topic) return null;

    const content = helpContent[topic];

    if (!content) {
         return (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-[80]">
                <div className="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl p-6 border border-gray-700 max-h-[90vh] flex flex-col">
                     <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-red-400">ヘルプが見つかりません</h2>
                        <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-700 transition"><Icons.XIcon /></button>
                    </div>
                    <p>この項目に関するヘルプは現在準備中です。</p>
                </div>
            </div>
        );
    }

    return (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-[80]">
            <div className="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl p-6 border border-gray-700 max-h-[90vh] flex flex-col">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xl font-bold text-indigo-400 flex items-center">{content.title}</h2>
                    <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-700 transition"><Icons.XIcon /></button>
                </div>
                <div className="flex-grow overflow-y-auto pr-2 space-y-6">
                    <p className="text-gray-300">{content.description}</p>
                    {content.sections.map((section, index) => (
                        <div key={index} className="border-t border-gray-700 pt-4">
                            <h3 className="font-semibold text-lg text-lime-400">{section.heading}</h3>
                            <p className="mt-1 text-sm">{section.body}</p>
                            {section.example && (
                                <div className="mt-3 p-3 bg-gray-900/50 rounded-md">
                                    <p className="text-xs text-gray-400 mb-1">文章例：</p>
                                    <p className="text-sm font-mono italic" dangerouslySetInnerHTML={{ __html: `&quot;${parseMarkdown(section.example)}&quot;` }}></p>
                                </div>
                            )}
                            {section.useCase && (
                                <div className="mt-3 p-3 bg-gray-900/50 rounded-md">
                                    <p className="text-xs text-gray-400 mb-1">おすすめの利用シーン：</p>
                                    <p className="text-sm">{section.useCase}</p>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};

export const GeneralHelpModal = ({ isOpen, onClose }) => {
    const startTutorial = useStore(state => state.startTutorial);
    const [activeDocKey, setActiveDocKey] = useState('index.md');
    const contentRef = useRef<HTMLDivElement>(null);

    const docTitles = {
        'index.md': 'はじめに',
        '01-project-management.md': '1. プロジェクト管理',
        '02-screen-layout.md': '2. 画面の見方',
        '03-library-panel.md': '3. 設定・資料の管理',
        '04-assistant-panel.md': '4. AIと一緒に書く',
        '05-main-panel.md': '5. 本文を書く・整える',
        '06-ai-settings.md': '6. AIの性格設定',
        '07-ui-reference.md': '7. UIリファレンス',
        '08-test-cases.md': '8. テストケース',
        '09-user-acceptance-test.md': '9. テストシナリオ',
    };

    useEffect(() => {
        if (!isOpen) return;
        setActiveDocKey('index.md');
    }, [isOpen]);

    useEffect(() => {
        if (!isOpen) return;
        const contentEl = contentRef.current;
        if (!contentEl) return;

        const handleClick = (e: MouseEvent) => {
            const target = e.target as HTMLElement;
            const anchor = target.closest('a');

            if (!anchor) return;
            
            const docKey = anchor.getAttribute('data-doc-key');
            const href = anchor.getAttribute('href');

            // Handle internal document links (stored in data-doc-key)
            if (anchor.classList.contains('internal-link') && docKey) {
                e.preventDefault();
                if (manualContent[docKey]) {
                    setActiveDocKey(docKey);
                    contentEl.scrollTop = 0;
                }
            } 
            // Handle same-page anchor links
            else if (anchor.classList.contains('anchor-link') && href?.startsWith('#')) {
                e.preventDefault();
                try {
                    const id = decodeURIComponent(href);
                    const element = contentEl.querySelector(id);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                } catch (error) {
                    console.error("Could not scroll to anchor:", error);
                }
            }
        };

        contentEl.addEventListener('click', handleClick);
        return () => {
            if (contentEl) {
                contentEl.removeEventListener('click', handleClick);
            }
        };
    }, [isOpen]); // Re-attach listener only when modal opens/closes

    const handleStartTutorial = () => {
        onClose();
        // A short delay to allow the help modal to close smoothly
        setTimeout(() => {
            startTutorial();
        }, 300);
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-[80]">
            <div className="bg-gray-800 rounded-lg shadow-xl w-full max-w-5xl h-[90vh] flex flex-col border border-gray-700">
                <div className="flex justify-between items-center p-4 border-b border-gray-700 flex-shrink-0">
                    <h2 className="text-xl font-bold text-indigo-400 flex items-center gap-2"><Icons.HelpCircleIcon />取扱説明書</h2>
                    <div className="flex items-center gap-4">
                        <button onClick={handleStartTutorial} className="flex items-center gap-2 px-3 py-1.5 text-sm rounded-md btn-pressable btn-invert-orange">
                            <Icons.BeginnerIcon className="h-4 w-4" />
                            <span>チュートリアルを再開</span>
                        </button>
                        <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-700 transition"><Icons.XIcon /></button>
                    </div>
                </div>
                <div className="flex-grow flex min-h-0">
                    <aside className="w-1/4 p-4 border-r border-gray-700 overflow-y-auto">
                        <ul className="space-y-1">
                            {Object.entries(docTitles).map(([key, title]) => (
                                <li key={key}>
                                    <button
                                        onClick={() => setActiveDocKey(key)}
                                        className={`w-full text-left text-sm p-2 rounded-md transition-colors ${activeDocKey === key ? 'bg-indigo-600/50 text-white font-semibold' : 'text-gray-400 hover:bg-gray-700/50 hover:text-white'}`}
                                    >
                                        {title}
                                    </button>
                                </li>
                            ))}
                        </ul>
                    </aside>
                    <main ref={contentRef} className="w-3/4 p-6 overflow-y-auto">
                        {activeDocKey === '07-ui-reference.md' ? (
                            <pre className="text-sm whitespace-pre-wrap font-mono text-gray-300">{manualContent[activeDocKey]}</pre>
                        ) : (
                            <div
                                className="prose prose-invert prose-lg max-w-full"
                                dangerouslySetInnerHTML={{ __html: parseMarkdown(manualContent[activeDocKey] || '', [], [], undefined, { applyKnowledgeLinks: false }) }}
                            />
                        )}
                    </main>
                </div>
            </div>
        </div>
    );
};
